<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Remindr + Uniform Scanner — เตือนความจำ & ตรวจเครื่องแบบ</title>
<style>
  :root{
    --bg:#0f1115;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent:#7c5cff;
    --accent-2:#00e5b7;
    --text:#e6eef8;
    --muted: #98a0b3;
    --danger:#ff6b6b;
    --radius:12px;
    font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.12), transparent 8%),
    radial-gradient(1000px 500px at 90% 90%, rgba(0,229,183,0.06), transparent 6%),
    var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    max-width:1200px;
    margin:28px auto;
    padding:20px;
    display:grid;
    gap:18px;
    grid-template-columns: 360px 1fr;
  }

  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
    backdrop-filter: blur(8px) saturate(120%);
  }

  header.site-header{
    grid-column:1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:10px;background: linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;}
  h1{margin:0;font-size:18px}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  form input, form textarea, form button, select{
    width:100%;box-sizing:border-box;
    border-radius:10px;padding:9px 10px;border:1px solid rgba(255,255,255,0.04);
    background:rgba(0,0,0,0.25);color:var(--text);
    font-size:14px;
    outline:none;
  }
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}

  .controls{display:grid;gap:10px}

  .add-btn{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px 12px;font-weight:600;border:none;cursor:pointer;background: linear-gradient(90deg,var(--accent), #5bb3ff);color:white;border-radius:10px;transition:transform .12s ease;}
  .small{font-size:13px;padding:8px 10px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);}

  .list{display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;padding-right:8px}
  .rem{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .rem .meta{flex:1}
  .title{font-weight:700;font-size:15px;margin-bottom:6px}
  .time{font-size:13px;color:var(--muted)}
  .note{font-size:13px;color:var(--muted);margin-top:6px}
  .badge{padding:5px 8px;border-radius:8px;font-size:12px;background:rgba(0,0,0,0.25)}

  .actions{display:flex;flex-direction:column;gap:8px}
  .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
  .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
  footer.note{grid-column:1 / -1;color:var(--muted);font-size:13px;text-align:center;padding-top:4px}

  /* uniform area */
  .scanner-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .cam-view{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:#0b0c0f;padding:8px}
  video, canvas {width:100%;height:auto;border-radius:8px;display:block}
  .controls-row{display:flex;gap:8px;align-items:center}

  table{width:100%;border-collapse:collapse;font-size:13px;color:var(--text)}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
  .score-high{color:#b7f0d8}
  .score-mid{color:#ffdca0}
  .score-low{color:#ffb3b3}
  .chip{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}

  @media (max-width:980px){
    .wrap{grid-template-columns:1fr;padding:12px;margin:12px}
    .scanner-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="site-header">
      <div class="brand">
        <div class="logo">R</div>
        <div>
          <h1>Remindr • Uniform Scan</h1>
          <p class="lead">เตือนความจำ + เครื่องมือช่วยตรวจเครื่องแบบและบันทึกคะแนน</p>
        </div>
      </div>
      <div style="text-align:right">
        <div style="margin-bottom:6px;color:var(--muted)">สถานะการแจ้งเตือน: <span id="notifStatus" class="badge">ไม่ทราบ</span></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="requestPerm" class="small">ขออนุญาตแจ้งเตือน</button>
          <button id="clearAll" class="small" title="ลบทุกเตือน">ลบเตือนทั้งหมด</button>
        </div>
      </div>
    </header>

    <!-- left column: add reminder (same as before) -->
    <section class="panel">
      <h3 style="margin-top:0">เพิ่มเตือนความจำ</h3>
      <form id="remForm" class="controls" onsubmit="return false;">
        <div>
          <label>หัวข้อ</label>
          <input id="title" placeholder="เช่น จ่ายบิล, นัดหมอ, ฝึกภาษา 20 นาที" required>
        </div>
        <div>
          <label>วันที่และเวลา</label>
          <input id="datetime" type="datetime-local" required>
        </div>
        <div>
          <label>โน้ต (ไม่บังคับ)</label>
          <textarea id="note" rows="3" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="addBtn" class="add-btn">➕ เพิ่มเตือน</button>
          <select id="quick" class="small" title="ตัวช่วยเวลารวดเร็ว">
            <option value="">ตัวช่วยด่วน</option>
            <option value="PT10M">10 นาทีจากนี้</option>
            <option value="PT30M">30 นาทีจากนี้</option>
            <option value="PT1H">1 ชั่วโมงจากนี้</option>
            <option value="PT1D">1 วันจากนี้</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="pinned" style="width:16px;height:16px">
          <label for="pinned" style="margin:0">ปักหมุดเตือน (แสดงบน top)</label>
        </div>
      </form>

      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        เคล็ดลับ: ให้สิทธิ์การแจ้งเตือน (browser) เพื่อให้ระบบแจ้งเตือนแม้คุณจะไม่ได้มองหน้าเว็บ
      </div>
    </section>

    <!-- right column: list and uniform scanner -->
    <section class="panel">
      <div class="top-row">
        <div>
          <h3 style="margin:0">รายการเตือน & เครื่องมือสแกน</h3>
          <div style="color:var(--muted);font-size:13px">รวมเตือนและบันทึกการตรวจเครื่องแบบ</div>
        </div>
        <div style="display:flex;gap:8px">
          <select id="viewFilter" class="small">
            <option value="upcoming">Upcoming</option>
            <option value="all">All</option>
            <option value="done">Done</option>
            <option value="triggered">Triggered</option>
          </select>
          <input id="search" class="small" placeholder="ค้นหา..." />
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:12px">
        <div>
          <div class="list" id="list"></div>
        </div>

        <!-- Uniform scanner panel -->
        <div class="panel" style="padding:12px">
          <h4 style="margin:6px 0">Uniform Scanner</h4>
          <div style="color:var(--muted);font-size:13px;margin-bottom:8px">เลือกโหมดตรวจและบันทึกคะแนนนักเรียน</div>

          <div style="display:grid;gap:8px">
            <label>โหมด</label>
            <select id="scanMode" class="small">
              <option value="manual">Manual (เช็คลิสต์)</option>
              <option value="auto">Auto (วิเคราะห์สีจากภาพ)</option>
            </select>

            <label>นักเรียน / รหัส</label>
            <input id="studentName" placeholder="ชื่อ นามสกุล หรือ รหัสนักเรียน">

            <label>คาดหวังสีเสื้อ (hex)</label>
            <input id="expectedColor" placeholder="#ffffff หรือ leave blank" value="#ffffff">

            <div class="scanner-grid" style="margin-top:6px">
              <div class="cam-view">
                <video id="video" autoplay playsinline style="display:none"></video>
                <canvas id="canvas" width="640" height="480"></canvas>
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                  <input id="uploadImg" type="file" accept="image/*" class="small">
                  <button id="startCam" class="small">เปิดกล้อง</button>
                  <button id="snap" class="small">จับภาพ</button>
                  <button id="stopCam" class="small">ปิดกล้อง</button>
                </div>
                <div style="margin-top:8px;color:var(--muted);font-size:13px">ตัวช่วย Auto : ระบบจะวิเคราะห์สีเฉลี่ยบริเวณกลางภาพเพื่อเทียบกับสีที่คาดหวัง (ช่วยตัดเบื้องต้น)</div>
              </div>

              <div style="display:flex;flex-direction:column;gap:8px">
                <div style="display:flex;gap:8px">
                  <button id="analyze" class="small">วิเคราะห์ภาพ (Auto)</button>
                  <button id="scoreManual" class="small">บันทึกคะแนน (Manual)</button>
                </div>

                <div style="background:var(--glass);padding:8px;border-radius:8px">
                  <div style="font-size:13px;color:var(--muted)">ผลการวิเคราะห์</div>
                  <div style="margin-top:8px">
                    <div>สีเฉลี่ย: <span id="avgColor" class="chip">—</span></div>
                    <div>คะแนนสี: <strong id="colorScore">—</strong></div>
                    <div style="margin-top:8px">คะแนนรวม: <strong id="finalScore">—</strong></div>
                  </div>
                </div>

                <div style="background:var(--glass);padding:8px;border-radius:8px">
                  <div style="font-size:13px;color:var(--muted)">เช็คลิสต์ (Manual)</div>
                  <div style="display:grid;gap:6px;margin-top:8px">
                    <label><input type="checkbox" id="chkShirt"> เสื้อถูกต้อง</label>
                    <label><input type="checkbox" id="chkBottom"> กางเกง/กระโปรงถูกต้อง</label>
                    <label><input type="checkbox" id="chkShoes"> รองเท้าเรียบร้อย</label>
                    <label><input type="checkbox" id="chkHair"> ทรงผม/แต่งกายเรียบร้อย</label>
                    <label><input type="checkbox" id="chkNameTag"> ป้ายชื่อ/บัตรประจำตัว</label>
                    <label>หมายเหตุ</label>
                    <textarea id="scanNote" rows="3" placeholder="ข้อสังเกตเพิ่มเติม..."></textarea>
                  </div>
                </div>

                <div style="display:flex;gap:8px;justify-content:flex-end">
                  <button id="saveRecord" class="small">บันทึกเรคคอร์ด</button>
                  <button id="exportCSV" class="small">Export CSV</button>
                </div>
              </div>
            </div>

            <div style="margin-top:8px">
              <h4 style="margin:6px 0">ประวัติการตรวจ</h4>
              <div style="max-height:220px;overflow:auto">
                <table id="recordsTable">
                  <thead><tr><th>เวลา</th><th>นักเรียน</th><th>คะแนน</th><th>โหมด</th><th>คำสั่ง</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <footer class="note">สร้างโดย Remindr • ข้อมูลเก็บบนเบราว์เซอร์ (localStorage)</footer>
    </section>
  </div>

<script>
/* Remindr + Uniform Scanner single-file app */

// ---------- Utilities ----------
const $ = id => document.getElementById(id);
const lsRemKey = 'remindr_v1';
const lsRecKey = 'remindr_uniform_records_v1';

function saveLS(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadLS(key, fallback){ try{ const s = localStorage.getItem(key); return s? JSON.parse(s) : fallback; }catch(e){ return fallback; } }
function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function formatTime(ts){
  const d = new Date(ts);
  return d.toLocaleString('th-TH', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// ---------- Reminder (same as before, slightly compacted) ----------
let reminders = [];
let checkTimer = null;
let audioCtx = null;

function loadReminders(){ reminders = loadLS(lsRemKey, []); }
function saveReminders(){ saveLS(lsRemKey, reminders); }
function addReminder({title, timeISO, note = '', pinned = false}){
  const when = new Date(timeISO).getTime();
  if(isNaN(when)) return false;
  const r = { id: uid(), title: title.trim(), time: when, note: note.trim(), pinned: !!pinned, done:false, triggered:false, createdAt:Date.now() };
  reminders.push(r);
  reminders.sort((a,b) => (b.pinned - a.pinned) || (a.time - b.time));
  saveReminders(); renderReminders(); return true;
}

function renderReminders(){
  const container = $('list');
  const filter = $('viewFilter').value;
  const q = $('search').value.toLowerCase().trim();
  container.innerHTML = '';
  let list = reminders.slice();
  if(filter === 'upcoming') list = list.filter(r=>!r.done && !r.triggered && r.time > Date.now());
  if(filter === 'done') list = list.filter(r=>r.done);
  if(filter === 'triggered') list = list.filter(r=>r.triggered && !r.done);
  if(q) list = list.filter(r => (r.title + ' ' + r.note).toLowerCase().includes(q));
  list.sort((a,b) => (b.pinned - a.pinned) || (a.time - b.time));
  if(list.length === 0){ container.innerHTML = `<div style="color:var(--muted);padding:12px;border-radius:8px">ไม่มีเตือนตามเงื่อนไข</div>`; return; }
  for(const r of list){
    const div = document.createElement('div'); div.className='rem';
    div.innerHTML = `<div class="meta">
      <div style="display:flex;gap:8px;align-items:center"><div class="title">${escapeHtml(r.title)}</div>
      ${r.pinned? '<div class="badge">📌</div>': ''} ${r.done? '<div class="badge" style="background:rgba(0,200,100,0.06);color:#b7f0d8">Done</div>':''}
      ${r.triggered && !r.done? '<div class="badge" style="background:rgba(255,200,50,0.06);color:#ffdca0">Triggered</div>':''}
      </div>
      <div class="time">${formatTime(r.time)}</div>
      ${r.note? `<div class="note">${escapeHtml(r.note)}</div>` : ''}
    </div>
    <div class="actions">
      <button class="icon-btn" data-id="${r.id}" data-action="snooze">⏱</button>
      <button class="icon-btn" data-id="${r.id}" data-action="done">${r.done? '↺' : '✓'}</button>
      <button class="icon-btn" data-id="${r.id}" data-action="pin">${r.pinned? '📌' : '📍'}</button>
      <button class="icon-btn" data-id="${r.id}" data-action="del">🗑</button>
    </div>`;
    container.appendChild(div);
  }
  container.querySelectorAll('.icon-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ handleAction(btn.dataset.id, btn.dataset.action); });
  });
}

function handleAction(id, action){
  const idx = reminders.findIndex(r=>r.id===id); if(idx===-1) return;
  const r = reminders[idx];
  if(action==='del'){ if(confirm('ลบเตือนนี้?')) { reminders.splice(idx,1); saveReminders(); renderReminders(); } }
  else if(action==='done'){ r.done = !r.done; if(r.done) r.triggered=false; saveReminders(); renderReminders(); }
  else if(action==='pin'){ r.pinned = !r.pinned; saveReminders(); renderReminders(); }
  else if(action==='snooze'){ r.time = Date.now() + 5*60*1000; r.triggered=false; r.done=false; saveReminders(); renderReminders(); }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function startChecking(){
  if(checkTimer) return;
  checkTimer = setInterval(()=>{
    const now = Date.now();
    for(const r of reminders){
      if(!r.triggered && !r.done && r.time <= now) triggerReminder(r);
    }
  }, 1000);
}
function playBeep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination);
    const now = audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(0.2, now+0.02); o.start(now);
    g.gain.exponentialRampToValueAtTime(0.0001, now+1.0); o.stop(now+1.05);
  }catch(e){}
}
function showModal(r){
  // simple browser alert modal replaced with window focus and sound (for brevity)
  alert('เตือน: ' + r.title + '\n' + (r.note || ''));
}
function triggerReminder(r){
  r.triggered = true; saveReminders(); renderReminders();
  if(Notification.permission === 'granted') new Notification(r.title, {body: r.note || ('เตือนเมื่อ ' + new Date(r.time).toLocaleString()), tag: r.id});
  playBeep(); showModal(r);
}

// ---------- Permission / init ----------
function updateNotifStatus(){ $('notifStatus').textContent = Notification.permission; }
function requestPermission(){ if(!('Notification' in window)){ alert('เบราว์เซอร์ไม่รองรับ Notification'); return; } Notification.requestPermission().then(updateNotifStatus); }

// ---------- Init reminders UI ----------
document.addEventListener('DOMContentLoaded', ()=>{
  loadReminders(); renderReminders(); startChecking(); updateNotifStatus();

  $('requestPerm').addEventListener('click', requestPermission);
  $('clearAll').addEventListener('click', ()=>{ if(confirm('ลบทุกเตือน?')){ reminders=[]; saveReminders(); renderReminders(); } });

  $('addBtn').addEventListener('click', ()=>{
    const title = $('title').value.trim(); const dt = $('datetime').value; const note = $('note').value; const pinned = $('pinned').checked;
    if(!title){ alert('กรุณากรอกหัวข้อ'); return; } if(!dt){ alert('กรุณาเลือกวันที่และเวลา'); return; }
    if(addReminder({title, timeISO: dt, note, pinned})){ $('title').value=''; $('note').value=''; $('pinned').checked=false; }
  });
  $('quick').addEventListener('change', e=> applyQuick(e.target.value));
  $('viewFilter').addEventListener('change', renderReminders);
  $('search').addEventListener('input', renderReminders);
});

// quick helper parse ISO durations like PT10M
function applyQuick(value){
  if(!value) return;
  const now = new Date(); let future = now;
  if(value.startsWith('PT')){ const hours = Number((value.match(/(\d+)H/)||[])[1]||0); const mins = Number((value.match(/(\d+)M/)||[])[1]||0); future = new Date(Date.now() + (hours*3600 + mins*60)*1000); }
  else if(value === 'PT1D'|| value==='P1D'){ future = new Date(Date.now()+24*3600*1000); }
  $('datetime').value = future.toISOString().slice(0,16);
}

// ---------- Uniform scanner logic ----------

// records structure: {id,name,ts,mode,colorAvgHex,colorScore,manualChecks:{...},note,finalScore,imageDataUrl}
let records = loadLS(lsRecKey, []);

function renderRecords(){
  const tbody = document.querySelector('#recordsTable tbody'); tbody.innerHTML='';
  if(records.length===0){ tbody.innerHTML='<tr><td colspan="5" style="color:var(--muted)">ไม่มีประวัติ</td></tr>'; return; }
  const rows = records.slice().sort((a,b)=> b.ts - a.ts);
  for(const r of rows){
    const tr = document.createElement('tr');
    const scoreClass = r.finalScore >= 85 ? 'score-high' : (r.finalScore >= 60 ? 'score-mid' : 'score-low');
    tr.innerHTML = `<td>${formatTime(r.ts)}</td>
      <td>${escapeHtml(r.name||'—')}</td>
      <td class="${scoreClass}">${r.finalScore}%</td>
      <td>${r.mode}</td>
      <td>
        <button class="small" data-id="${r.id}" data-action="view">ดู</button>
        <button class="small" data-id="${r.id}" data-action="del">ลบ</button>
      </td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id=btn.dataset.id, action=btn.dataset.action;
      const idx = records.findIndex(x=>x.id===id); if(idx===-1) return;
      if(action==='del'){ if(confirm('ลบเรคคอร์ด?')) { records.splice(idx,1); saveLS(lsRecKey, records); renderRecords(); } }
      else if(action==='view'){ const r = records[idx]; viewRecordModal(r); }
    });
  });
}

function viewRecordModal(r){
  // simple viewer using alert for brevity; could be improved
  let s = `เวลา: ${formatTime(r.ts)}\nนักเรียน: ${r.name}\nโหมด: ${r.mode}\nคะแนนรวม: ${r.finalScore}%\nสีเฉลี่ย: ${r.colorAvgHex||'—'} (สี: ${r.colorScore||'—'})\nหมายเหตุ: ${r.note||''}\n`;
  alert(s);
}

// image / camera handling
let videoStream = null;
const video = $('video'), canvas = $('canvas'), ctx = canvas.getContext('2d');

$('startCam').addEventListener('click', async ()=>{
  try{
    video.style.display='block';
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    video.srcObject = stream; video.play(); videoStream = stream;
  }catch(e){ alert('ไม่สามารถเปิดกล้องได้: ' + e.message); }
});
$('stopCam').addEventListener('click', ()=>{
  if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; video.srcObject=null; video.style.display='none'; }
});
$('snap').addEventListener('click', ()=>{
  if(video.srcObject){
    canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
    ctx.drawImage(video, 0,0, canvas.width, canvas.height);
  } else {
    alert('กล้องยังไม่เปิด');
  }
});

// upload image
$('uploadImg').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const img = new Image();
    img.onload = ()=> {
      canvas.width = img.width; canvas.height = img.height;
      ctx.drawImage(img, 0,0);
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
});

// color analysis: sample central box and compute average RGB
function getAverageColorSample(boxRatio=0.4){
  const w = canvas.width, h = canvas.height;
  if(!w || !h) return null;
  const bw = Math.floor(w * boxRatio), bh = Math.floor(h * boxRatio);
  const sx = Math.floor((w - bw)/2), sy = Math.floor((h - bh)/2);
  try{
    const imgd = ctx.getImageData(sx, sy, bw, bh).data;
    let r=0,g=0,b=0,count=0;
    for(let i=0;i<imgd.length;i+=4){
      r+=imgd[i]; g+=imgd[i+1]; b+=imgd[i+2]; count++;
    }
    if(count===0) return null;
    r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
    return {r,g,b};
  }catch(e){ return null; }
}
function rgbToHex({r,g,b}){ return '#' + [r,g,b].map(x=> x.toString(16).padStart(2,'0')).join('').toUpperCase(); }
function colorDistance(c1, c2){ // euclidean in rgb
  return Math.sqrt((c1.r-c2.r)**2 + (c1.g-c2.g)**2 + (c1.b-c2.b)**2);
}
function hexToRgb(hex){
  if(!hex) return null;
  let h = hex.replace('#','');
  if(h.length===3) h = h.split('').map(ch=> ch+ch).join('');
  if(h.length!==6) return null;
  return { r: parseInt(h.slice(0,2),16), g: parseInt(h.slice(2,4),16), b: parseInt(h.slice(4,6),16) };
}

// analyze button
$('analyze').addEventListener('click', ()=>{
  const avg = getAverageColorSample(0.35);
  if(!avg){ alert('ยังไม่มีรูปภาพหรือจับภาพไม่สำเร็จ'); return; }
  const hex = rgbToHex(avg);
  $('avgColor').textContent = hex;
  $('avgColor').style.background = hex;
  // get expected color
  const expHex = ($('expectedColor').value || '').trim();
  let colorScore = '—';
  let finalScore = '—';
  if(expHex){
    const expRgb = hexToRgb(expHex);
    if(!expRgb){ alert('ค่าสีที่คาดหวังไม่ถูกต้อง (ใช้รูปแบบ #RRGGBB)'); return; }
    const dist = colorDistance(avg, expRgb); // 0..~441
    // map to score 0..100 (0 distance -> 100)
    const maxDist = Math.sqrt(255*255*3);
    const score = Math.round((1 - clamp(dist / maxDist, 0, 1)) * 100);
    colorScore = score;
    // for demo, final score = colorScore (50%) + manual checks (if any) (50%)
    // compute manual checks
    const checks = getManualChecks();
    const manualScore = Math.round((Object.values(checks).filter(v=>v).length / Object.keys(checks).length) * 100);
    finalScore = Math.round((colorScore*0.5) + (manualScore*0.5));
    $('colorScore').textContent = colorScore;
    $('finalScore').textContent = finalScore + '%';
  } else {
    // if no expected color, only manual
    const checks = getManualChecks();
    const manualScore = Math.round((Object.values(checks).filter(v=>v).length / Object.keys(checks).length) * 100);
    $('colorScore').textContent = '—';
    $('finalScore').textContent = manualScore + '%';
  }
});

// manual scoring helper
function getManualChecks(){
  return {
    shirt: $('chkShirt').checked,
    bottom: $('chkBottom').checked,
    shoes: $('chkShoes').checked,
    hair: $('chkHair').checked,
    nametag: $('chkNameTag').checked
  };
}

// save record
$('saveRecord').addEventListener('click', ()=>{
  const name = $('studentName').value.trim() || '—';
  const mode = $('scanMode').value;
  const avg = getAverageColorSample(0.35);
  const colorHex = avg ? rgbToHex(avg) : null;
  const colorScoreVal = $('colorScore').textContent === '—' ? null : Number($('colorScore').textContent);
  // compute manual score
  const checks = getManualChecks();
  const manualScore = Math.round((Object.values(checks).filter(v=>v).length / Object.keys(checks).length) * 100);
  let finalScore;
  if(colorScoreVal !== null) finalScore = Math.round(colorScoreVal*0.5 + manualScore*0.5);
  else finalScore = manualScore;
  // image snapshot data
  const imageData = canvas.toDataURL('image/jpeg', 0.8);
  const rec = {
    id: uid(),
    name, ts: Date.now(), mode,
    colorAvgHex: colorHex, colorScore: colorScoreVal,
    manualChecks: checks, note: $('scanNote').value || '',
    finalScore, imageData
  };
  records.push(rec); saveLS(lsRecKey, records); renderRecords();
  alert('บันทึกเรียบร้อย — คะแนน: ' + finalScore + '%');
});

// export CSV
$('exportCSV').addEventListener('click', ()=>{
  if(records.length===0){ alert('ไม่มีข้อมูลให้ export'); return; }
  const rows = [['id','time','name','mode','finalScore','colorAvgHex','colorScore','note']];
  for(const r of records) rows.push([r.id, new Date(r.ts).toISOString(), r.name, r.mode, r.finalScore, r.colorAvgHex||'', r.colorScore||'', (r.note||'').replace(/\n/g,' ')]);
  const csv = rows.map(a => a.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'uniform_records.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// analyze fallback: if manual mode and no color expected, compute only manual when click scoreManual
$('scoreManual').addEventListener('click', ()=> {
  const checks = getManualChecks();
  const manualScore = Math.round((Object.values(checks).filter(v=>v).length / Object.keys(checks).length) * 100);
  $('finalScore').textContent = manualScore + '%';
});

// initial render of records
renderRecords();

// small helper to view image in new tab when clicking avgColor (optional)
$('avgColor').addEventListener('click', ()=>{
  const data = canvas.toDataURL('image/png'); const w = window.open('about:blank','_blank'); if(w) w.document.write('<img src="'+data+'">');
});

// resume audio on user gesture for reminders
function resumeAudioOnUserGesture(){
  const resume = ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); window.removeEventListener('pointerdown', resume); window.removeEventListener('keydown', resume); }
  window.addEventListener('pointerdown', resume); window.addEventListener('keydown', resume);
}
resumeAudioOnUserGesture();

</script>
</body>
</html>